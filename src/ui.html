<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
      body {
        font-family: 'Roboto', 'Arial', sans-serif;
        color: #3c4043;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
      }
      .json-container {
        background-color: #f8f9fa;
        border: 1px solid #dadce0;
        border-radius: 8px;
        margin: 15px 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .json-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #e8f0fe;
        border-bottom: 1px solid #dadce0;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .json-title {
        font-weight: 500;
        color: #1a73e8;
      }
      .json-actions {
        display: flex;
        gap: 8px;
      }
      .json-content {
        padding: 15px;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: 'Menlo', 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.5;
        overflow-x: auto;
        background-color: white;
      }
      .tab-container {
        display: flex;
        justify-content: space-around;
        border-bottom: 1px solid #dadce0;
        background-color: #e8f0fe;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .tab-button {
        flex-grow: 1;
        padding: 12px 0;
        text-align: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #5f6368;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
      }
      .tab-button.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
        background-color: #e8f0fe;
      }
      .tab-button:hover:not(.active) {
        background-color: #f1f3f4;
      }
      .tab-content {
        padding: 20px;
      }
      #chatLog {
        height: 350px;
        overflow-y: auto;
        border: 1px solid #dadce0;
        padding: 10px;
        margin-bottom: 15px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
      }
      .message-container {
        margin-bottom: 10px;
        line-height: 1.4;
      }
      .message-container b {
        font-weight: 600;
      }
      .message-container.you b {
        color: #34a853;
      }
      .message-container.bot b {
        color: #1a73e8;
      }
      .input-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      #userInput {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #dadce0;
        border-radius: 8px;
        font-size: 14px;
      }
      .results-summary {
        font-size: 14px;
        margin-top: 10px;
        background-color: #e8f0fe;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
      }
      #sendBtn {
          background-color: #e8f0fe; /* Example: blue */
          color: #5f6368;               /* Example: white text */
          border-radius: 8px;
          padding: 10px 15px;
          cursor: pointer;
          font-size: 14px;
          border: 1px solid #e8f0fe;
          transition: all 0.2s;
      }
        #sendBtn:hover {
        background-color: #f1f3f4;
        border-color: #c5c7c9;
      }
      .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      .action-buttons button {
        padding: 10px 15px;
        border: 1px solid #e8f0fe;
        background-color: #e8f0fe;
        color: #5f6368;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }
      .action-buttons button:hover {
        background-color: #f1f3f4;
        border-color: #c5c7c9;
      }
      .issue {
        margin-bottom: 10px;
        padding: 15px;
        border-radius: 8px;
        transition: background-color 0.2s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .issue.error {
        border-left: 4px solid #d93025;
        background-color: #fce8e6;
      }
      .issue.warn {
        border-left: 4px solid #f9ab00;
        background-color: #fff7e6;
      }
      .issue-header {
        font-weight: bold;
        text-align: center;
        padding: 4px 0 4px 0;
        border-radius: 6px 6px 0 0;
        margin: -15px -15px 10px -15px;
        letter-spacing: 1px;
        font-size: 15px;
      }
      .issue-header.error {
        background: #e57373;
        color: #fff;
      }
      .issue-header.warn {
        background: #ffe082;
        color: #7c4700;
      }
      .issue-title {
        font-size: 15px;
        font-weight: 500;
        margin-bottom: 6px;
      }
      .issue:hover {
        background-color: #f1f3f4;
      }
      .issue-cell-link {
        font-weight: bold;
        text-decoration: underline;
        color: #3168c0;
        cursor: pointer;
      }
      pre {
        background-color: #f1f3f4;
        padding: 15px;
        border-radius: 8px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: 'Menlo', 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.5;
        overflow-x: auto;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 2s linear infinite;
        margin: 0 auto 10px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
        border-radius: 8px;
        text-align: center;
      }
      .modal-close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .modal-close:hover,
      .modal-close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="tab-container">
    <div id="chatTabBtn" class="tab-button active">Chat</div>
    <div id="resultsTabBtn" class="tab-button">Results</div>
  </div>

  <div id="chatTab" class="tab-content">
    <div id="chatLog"></div>
    <div class="input-container">
      <input type="text" id="userInput" placeholder="Ask me here!" />
      <button id="sendBtn">Send</button>
    </div>
    <div id="resultsInChat"></div>
    <div id="fixedJsonOutput" style="display: none; margin-top: 15px;">
      <h4>Corrected Load JSON:</h4>
      <pre id="fixedJsonPreview"></pre>
    </div>
    <div class="action-buttons">
      <button id="reanalyzeBtn">Re-analyze</button>
    </div>
  </div>

  <div id="resultsTab" class="tab-content" style="display: none;">
    <div id="resultsContent">
      <p>Run an analysis in the chat tab to see results here.</p>
    </div>
  </div>

    <!-- Message modal -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <p id="modalMessage"></p>
    </div>
  </div>

  <!-- Fix confirm modal -->
  <div id="fixConfirmModal" class="modal">
    <div class="modal-content">
      <p id="fixConfirmMessage"></p>
      <div class="modal-buttons">
        <button id="confirmFixBtn">Fix</button>
        <button id="cancelFixBtn">Cancel</button>
      </div>
      <div id="fixedJsonOutput" style="display: none; margin-top: 15px;">
        <h4>Corrected Load JSON:</h4>
        <pre id="fixedJsonPreview"></pre>
      </div>
    </div>
  </div>

  <script>
    // ======= state and element refs (will be assigned on init) =======
    let chatLog, userInput, sendBtn, resultsInChatDiv, reanalyzeBtn;
    let chatTabBtn, resultsTabBtn, chatTab, resultsTab, resultsContentDiv;
    let messageModal, modalMessage, fixConfirmModal, fixConfirmMessage, confirmFixBtn, cancelFixBtn, modalCloseBtn;

    let resultCache = null;      // store last analysis result
    let fixIssueIndex = null;    // index of issue user wants to fix

    // ====== helper functions ======
    function switchTab(tabName) {
      if (tabName === 'chat') {
        chatTabBtn.classList.add('active');
        resultsTabBtn.classList.remove('active');
        chatTab.style.display = 'block';
        resultsTab.style.display = 'none';
      } else {
        chatTabBtn.classList.remove('active');
        resultsTabBtn.classList.add('active');
        resultsTab.style.display = 'block';
        chatTab.style.display = 'none';
      }
    }

    function appendMessage(sender, text) {
      if (!chatLog) return;
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-container ${sender.toLowerCase()}`;
      const safeText = (typeof text === 'string' || text instanceof String) ? text : JSON.stringify(text);
      messageDiv.innerHTML = `<b>${sender}:</b> ${safeText}`;
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function showMessageModal(msg) {
      modalMessage.innerText = msg;
      messageModal.style.display = 'block';
    }

    function onError(err) {
      resultsInChatDiv.innerHTML = '';
      console.error('Error', err);
      showMessageModal(err && err.message ? err.message : JSON.stringify(err));
    }

    // ====== Analysis display in Chat (short summary) ======
    function displayChatAnalysisResult(result) {
      // For chat tab, only show issue summary and status
      if (!result || !result.issues || result.issues.length === 0) {
        appendMessage('Bot', "✅ No issues found. All good! Check the Results tab for the validated JSON data.");
        return;
      }
      
      // Count issues by severity
      const errorCount = result.issues.filter(i => i.severity === 'error').length;
      const warnCount = result.issues.filter(i => i.severity === 'warn').length;
      
      appendMessage('Bot', 
        `⚠️ Found ${result.issues.length} issue${result.issues.length > 1 ? 's' : ''} ` +
        `(${errorCount} error${errorCount !== 1 ? 's' : ''}, ${warnCount} warning${warnCount !== 1 ? 's' : ''}). ` +
        `Switch to the Results tab to see details and JSON output.`
      );

      // Show only a brief summary in chat
      if (result.aiSummary) {
        appendMessage('Bot', `🔧 ${result.aiSummary}`);
      }

      // Automatically switch to Results tab to show JSON
      switchTab('results');
      displayAnalysisResult(result);

      // store result for later Fix / Confirm actions
      resultCache = result;

      appendMessage(
        'Bot',
        `⚠️ Found ${result.issues.length} issue(s). <a href="#" class="view-results-link">View Results</a>`
      );

      // view result link
      const links = chatLog.querySelectorAll('.view-results-link');
      links.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          switchTab('results'); 
        });
      });
    }

    // ====== Full results rendering (Results tab) ======
    function displayAnalysisResult(result) {
      resultCache = result;  // cache it
      resultsContentDiv.innerHTML = '';
      resultsTab.style.display = 'block';

      // Create wrapper
      const wrapper = document.createElement('div');
      
      // Status header
      const statusHeader = document.createElement('div');
      statusHeader.style.marginBottom = '20px';
      statusHeader.style.textAlign = 'center';
      
      if (result.ok) {
        statusHeader.innerHTML = `
          <h3 style="color: #34a853;">✅ Analysis Complete!</h3>
          <p>All validation checks passed. Loads are ready to be pushed.</p>
        `;
      } else {
        const errorCount = result.issues.filter(i => i.severity === 'error').length;
        const warnCount = result.issues.filter(i => i.severity === 'warn').length;
        statusHeader.innerHTML = `
          <h3 style="color: ${errorCount > 0 ? '#ea4335' : '#fbbc04'}">
            ⚠️ Found ${result.issues.length} issue${result.issues.length !== 1 ? 's' : ''}
          </h3>
          <p>${errorCount} error${errorCount !== 1 ? 's' : ''}, ${warnCount} warning${warnCount !== 1 ? 's' : ''}</p>
        `;
      }
      wrapper.appendChild(statusHeader);

      // JSON Output Section
      const jsonContainer = document.createElement('div');
      jsonContainer.className = 'json-container';
      
      // JSON Header with actions
      const jsonHeader = document.createElement('div');
      jsonHeader.className = 'json-header';
      jsonHeader.innerHTML = `
        <div class="json-title">Validated Loads Data</div>
        <div class="json-actions">
          <button id="copyJsonBtn" class="action-button">
            <span style="margin-right: 4px;">📋</span> Copy
          </button>
          <button id="previewPushBtn" class="action-button">
            <span style="margin-right: 4px;">🚀</span> Preview Push
          </button>
        </div>
      `;
      jsonContainer.appendChild(jsonHeader);
      
      // JSON Content
      const jsonContent = document.createElement('pre');
      jsonContent.className = 'json-content';
      jsonContent.textContent = JSON.stringify(result.loads || [], null, 2);
      jsonContainer.appendChild(jsonContent);
      
      wrapper.appendChild(jsonContainer);

      // Style the action buttons
      const actionButtons = wrapper.querySelectorAll('.action-button');
      actionButtons.forEach(btn => {
        btn.style.cssText = `
          padding: 6px 12px;
          border: 1px solid #dadce0;
          border-radius: 4px;
          background-color: white;
          color: #1a73e8;
          cursor: pointer;
          font-size: 13px;
          transition: all 0.2s;
        `;
      });

      // Add event listeners
      wrapper.querySelector('#copyJsonBtn').addEventListener('click', copyJson);
      wrapper.querySelector('#previewPushBtn').addEventListener('click', previewPush);

      resultsContentDiv.appendChild(wrapper);

      // Issues mode
      const heading = document.createElement('h3'); heading.innerText = '⚠️ Issues Found:';
      resultsContentDiv.appendChild(heading);
      const hint = document.createElement('p'); hint.innerText = 'Click on a row number to jump to the cell.';
      resultsContentDiv.appendChild(hint);

      (result.issues || []).forEach((issue, i) => {
        const issueDiv = document.createElement('div');
        issueDiv.className = 'issue ' + (issue.severity || '');

        // Header: ERROR/WARN
        const header = document.createElement('div');
        header.className = 'issue-header ' + (issue.severity || '');
        header.innerText = (issue.severity || '').toUpperCase();
        issueDiv.appendChild(header);

        // Title: numbered issue name
        const title = document.createElement('div');
        title.className = 'issue-title';
        title.innerText = `${i + 1}. ${issue.message}`;
        issueDiv.appendChild(title);

        // Suggestion
        const suggestion = document.createElement('p');
        suggestion.innerHTML = `<small>Suggestion: ${issue.suggestion || "Please review and update the sheet manually."}</small>`;
        issueDiv.appendChild(suggestion);

        // affected rows (clickable links)
        if (Array.isArray(issue.rows) && issue.rows.length) {
          const rowsP = document.createElement('p');
          rowsP.appendChild(document.createTextNode('Affected Rows: '));
          issue.rows.forEach((row, idx) => {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'issue-cell-link';
            a.innerText = String(row );
            a.addEventListener('click', (e) => { e.preventDefault(); selectCell(issue.column || '', row); });
            rowsP.appendChild(a);
            if (idx < issue.rows.length) rowsP.appendChild(document.createTextNode(', '));
          });
          issueDiv.appendChild(rowsP);
        }

        // Fix link (always present so user can try)
        const fixLine = document.createElement('p');
        const fixA = document.createElement('a');
        fixA.href = '#';
        fixA.innerText = 'Fix';
        fixA.style.color = '#1a73e8';
        fixA.style.textDecoration = 'underline';
        fixA.addEventListener('click', (e) => { e.preventDefault(); confirmFix(i); });
        fixLine.appendChild(fixA);
        issueDiv.appendChild(fixLine);

        // If AI suggested a mapping target, show Confirm mapping link
        const mappingTarget = issue.suggestionTarget || issue.mappingTarget || issue.mapping || issue.suggestedMapping;
        if (issue.code === 'MISSING_COLUMN' && issue.column && mappingTarget) {
          const mapP = document.createElement('p');
          const mapA = document.createElement('a');
          mapA.href = '#';
          mapA.innerText = `Confirm mapping to '${mappingTarget}'`;
          mapA.style.color = '#1a73e8';
          mapA.style.textDecoration = 'underline';
          mapA.addEventListener('click', (e) => { e.preventDefault(); applyMapping(issue.column, mappingTarget); });
          mapP.appendChild(mapA);
          issueDiv.appendChild(mapP);
        }

        resultsContentDiv.appendChild(issueDiv);
      });
    }

    // ====== applyMapping (user confirmed header mapping) ======
    function applyMapping(header, targetField) {
      resultsInChatDiv.innerHTML = `<div class="loader"></div><p style="text-align:center;">Applying mapping...</p>`;
      google.script.run
        .withSuccessHandler((res) => {
          resultsInChatDiv.innerHTML = '';
          // expect new analysis result back
          if (res && typeof res === 'object' && 'issues' in res) {
            displayChatAnalysisResult(res);
            displayAnalysisResult(res);
            switchTab('results');
          } else {
            appendMessage('Bot', String(res));
          }
        })
        .withFailureHandler(onError)
        .handleChatMessage({
          command: 'apply_mapping',
          mapping: { [header]: targetField }
        });
    }

    // ====== Fix flow ======
    function confirmFix(index) {
      if (!resultCache || !resultCache.issues) return showMessageModal('No analysis cached.');
      fixIssueIndex = index;
      const issue = resultCache.issues[index];
      fixConfirmMessage.innerText = `Do you want me to fix this?\n\n${issue.message}\n\nSuggestion: ${issue.suggestion || '—'}`;
      fixConfirmModal.style.display = 'block';
    }

    function applyFix() {
      if (fixIssueIndex === null || !resultCache) {
        showMessageModal('No issue selected to fix.');
        return;
      }
      const issue = resultCache.issues[fixIssueIndex];
      appendMessage('Bot', `🤔 Analyzing issue: ${issue.message}`);
      fixConfirmModal.style.display = 'none';
      resultsInChatDiv.innerHTML = `<div class="loader"></div><p style="text-align:center;">AI is analyzing and fixing the issue...</p>`;

    google.script.run
        .withSuccessHandler((newResult) => {
          resultsInChatDiv.innerHTML = '';
          if (newResult && typeof newResult === 'object') {
            // Just show a simple confirmation message in the chat
            appendMessage('Bot', `✅ Fixed Issue ${fixIssueIndex + 1}.`);              

            // Then show AI's explanation
            if (newResult.aiSummary) {
              appendMessage('Bot', `🔍 ${newResult.aiSummary}`);
            }

            // Update the full analysis results in the Results tab
            displayChatAnalysisResult(newResult);
            displayAnalysisResult(newResult);
            
            // Show remaining issues count
            const remainingIssues = newResult.issues ? newResult.issues.length : 0;
            if (remainingIssues > 0) {
              appendMessage('Bot', `⚠️ ${remainingIssues} remaining issue${remainingIssues > 1 ? 's' : ''} found. Check the Results tab for details.`);
            } else {
              appendMessage('Bot', '✨ All issues have been resolved!');
            }

            switchTab('results');
        } else {
            appendMessage('Bot', `❌ Unable to fix: ${newResult || "Unknown error"}`);
        }
        })
        .withFailureHandler(onError)
        .handleChatMessage({ 
          command: 'apply_fix', 
          issue: issue,
          context: {
            issueIndex: fixIssueIndex,
            totalIssues: resultCache.issues.length
          }
        });
    }

    // ====== Selecting a cell (calls server-side) ======
    function selectCell(columnName, rowNum) {
      // call apps script which will set the active range (or whole row fallback)
      google.script.run
        .withSuccessHandler(function() {
          // focus back to sidebar if needed
        })
        .withFailureHandler(onError)
        .selectSheetCell(columnName, rowNum);
    }

    // ====== sendMessage (smart intent detection) ======
    function sendMessage(userMessage) {
      if (!userMessage || !userMessage.trim()) return;
      appendMessage('You', userMessage);
      userInput.value = '';
      resultsInChatDiv.innerHTML = `<div class="loader"></div><p style="text-align:center;">Thinking...</p>`;

      // detect "analyze"-like intents (not brittle)
      const intentText = userMessage.toLowerCase();
      const analyzePatterns = [
        /analy[sz]e/, /review/, /check/, /scan/, /validate/, /audit/, /inspect/
      ];
      const payload = { command: 'general_chat', message: userMessage };
      if (analyzePatterns.some(p => p.test(intentText))) {
        payload.command = 'analyze_sheet';
        payload.opts = {}; // keep for future use
      }

      google.script.run
        .withSuccessHandler((response) => {
          resultsInChatDiv.innerHTML = '';
          if (response && typeof response === 'object' && 'issues' in response) {
            displayChatAnalysisResult(response);
            displayAnalysisResult(response);
            // show results tab automatically for analysis
            switchTab('results');
          } else {
            // plain conversational response
            appendMessage('Bot', String(response));
          }
        })
        .withFailureHandler(onError)
        .handleChatMessage(payload);
    }

    // ====== utility actions ======
    function copyJson() {
      const pre = document.getElementById('jsonPreview');
      if (!pre) { showMessageModal('No JSON to copy.'); return; }
      const text = pre.innerText;
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); showMessageModal('JSON copied to clipboard!'); } 
      catch (e) { showMessageModal('Failed to copy JSON.'); }
      document.body.removeChild(ta);
    }

    function previewPush() {
      const pre = document.getElementById('jsonPreview');
      showMessageModal(pre ? pre.innerText : 'No JSON available.');
    }

    // ====== Initialize UI and event listeners safely ======
    function setButtonStyles() {
      // style main action buttons to match the existing look if needed
      const buttons = [sendBtn, reanalyzeBtn, confirmFixBtn, cancelFixBtn];
      buttons.forEach(btn => { if (!btn) return; btn.style.borderRadius = '8px'; btn.style.padding = '8px 12px'; });
    }

    function greetUser() {
      appendMessage('Bot', "👋 Hi! I'm your TruckTalk assistant. How may I help you?");
    }

    // Init after DOM ready
    function init() {
      // assign refs (elements exist now)
      chatLog = document.getElementById('chatLog');
      userInput = document.getElementById('userInput');
      sendBtn = document.getElementById('sendBtn');
      resultsInChatDiv = document.getElementById('resultsInChat');
      reanalyzeBtn = document.getElementById('reanalyzeBtn');
      chatTabBtn = document.getElementById('chatTabBtn');
      resultsTabBtn = document.getElementById('resultsTabBtn');
      chatTab = document.getElementById('chatTab');
      resultsTab = document.getElementById('resultsTab');
      resultsContentDiv = document.getElementById('resultsContent');
      messageModal = document.getElementById('messageModal');
      modalMessage = document.getElementById('modalMessage');
      fixConfirmModal = document.getElementById('fixConfirmModal');
      fixConfirmMessage = document.getElementById('fixConfirmMessage');
      confirmFixBtn = document.getElementById('confirmFixBtn');
      cancelFixBtn = document.getElementById('cancelFixBtn');
      modalCloseBtn = document.getElementsByClassName('modal-close')[0];

      // greeting
      greetUser();

      // event listeners
      sendBtn.addEventListener('click', () => sendMessage(userInput.value.trim()));
      userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(userInput.value.trim()); });
      reanalyzeBtn.addEventListener('click', () => sendMessage('reanalyze'));
      chatTabBtn.addEventListener('click', () => switchTab('chat'));
      resultsTabBtn.addEventListener('click', () => switchTab('results'));

      // modals
      if (modalCloseBtn) modalCloseBtn.addEventListener('click', () => messageModal.style.display = 'none');
      cancelFixBtn.addEventListener('click', () => fixConfirmModal.style.display = 'none');
      confirmFixBtn.addEventListener('click', applyFix);

      // click outside to close
      window.addEventListener('click', (ev) => {
        if (ev.target === messageModal) messageModal.style.display = 'none';
        if (ev.target === fixConfirmModal) fixConfirmModal.style.display = 'none';
      });

      setButtonStyles();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>