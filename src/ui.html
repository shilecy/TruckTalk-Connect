<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <title>TruckTalk Connect</title>
    <style>
      body { font-family: 'Roboto', Arial, sans-serif; margin: 0; color: #222; background:#fafafa; }
      .header { background:#1a73e8; color:#fff; padding:12px; font-weight:600; }
      .container { padding:12px; }
      .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
      #chatLog { display:none; } /* keep chat implementation, but main flow is analyze/results */
      .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#1a73e8; color:white; }
      .btn.secondary { background:#fff; color:#1a73e8; border:1px solid #1a73e8; }
      .issues { margin-top:12px; }
      .issue { padding:10px; border-radius:8px; margin-bottom:8px; }
      .issue.error { background:#fff0f0; border-left:4px solid #d93025; }
      .issue.warn { background:#fffaf0; border-left:4px solid #f9ab00; }
      .mapping-box { margin-top:10px; padding:10px; background:#ffffff; border-radius:8px; border:1px solid #ececec; }
      select { padding:6px; border-radius:6px; border:1px solid #ddd; }
      pre { background:#f1f3f4; padding:10px; border-radius:8px; max-height:220px; overflow:auto; font-size:13px; }
      .small { font-size:12px; color:#666; }
      .action-row { display:flex; gap:8px; margin-top:8px; }
      .loader { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px; }
      @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    </style>
  </head>
  <body>
    <div class="header">TruckTalk Connect</div>
    <div class="container">
      <div class="row">
        <button id="analyzeBtn" class="btn">Analyze current tab</button>
        <button id="reanalyzeBtn" class="btn secondary" disabled>Re-analyze</button>
      </div>

      <div id="status" class="small">Ready.</div>

      <div id="results" style="margin-top:12px;"></div>
    </div>

    <script>
      // Utility: call server handler
      function serverCall(fn, arg, onOk, onFail) {
        onFail = onFail || (e => { alert("Error: " + (e.message || e)); });
        google.script.run.withSuccessHandler(onOk).withFailureHandler(onFail)[fn](arg);
      }

      const analyzeBtn = document.getElementById('analyzeBtn');
      const reanalyzeBtn = document.getElementById('reanalyzeBtn');
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');

      function setStatus(txt) { statusEl.textContent = txt; }

      function handleAnalysisResponse(resp) {
        reanalyzeBtn.disabled = false;
        analyzeBtn.disabled = false;
        setStatus('Analysis finished: ' + (resp.ok ? 'OK' : 'Issues found'));

        // Build UI
        resultsEl.innerHTML = '';

        // Mapping section
        const headers = (resp && resp.meta && resp.mapping) ? Object.keys(resp.mapping) : null;
        // But we need the original sheet headers for dropdowns. We'll get them via getSheetHeaders RPC.
        serverCall('getSheetHeaders', null, function(headersResp) {
          // headersResp: array of header strings from sheet
          renderResults(resp, headersResp || []);
        });
      }

      analyzeBtn.onclick = () => {
        analyzeBtn.disabled = true;
        setStatus('Analyzing...');
        resultsEl.innerHTML = '<div class="small"><span class="loader"></span>Analyzing sheet...</div>';
        // Tell server to analyze sheet
        google.script.run.withSuccessHandler(handleAnalysisResponse).withFailureHandler(function(err){
          analyzeBtn.disabled = false;
          setStatus('Error: ' + (err.message || err));
          resultsEl.innerHTML = '';
        }).handleChatMessage({ command: 'analyze_sheet' });
      };

      reanalyzeBtn.onclick = () => {
        analyzeBtn.click();
      };

      // Renders analysis result - accepts resp (AnalysisResult) and sheetHeaders array
      function renderResults(resp, sheetHeaders) {
        resultsEl.innerHTML = '';

        // 1) Issues panel grouped by severity
        if (resp.issues && resp.issues.length) {
          const high = resp.issues.filter(i => i.severity === 'error');
          const warn = resp.issues.filter(i => i.severity === 'warn');

          const issuesDiv = document.createElement('div');
          issuesDiv.innerHTML = '<h4>Issues</h4><div class="small">Click an issue to jump to the corresponding cell (if row & column provided).</div>';
          if (high.length) {
            high.forEach(i => {
              const d = document.createElement('div'); d.className = 'issue error';
              d.innerHTML = `<div><strong>ERROR:</strong> ${i.message}</div><div class="small">Suggestion: ${i.suggestion || '-'}</div>`;
              if (i.rows && i.rows.length && i.column) {
                d.style.cursor = 'pointer';
                d.onclick = () => selectCell(i.column, i.rows[0]);
              }
              issuesDiv.appendChild(d);
            });
          }
          if (warn.length) {
            warn.forEach(i => {
              const d = document.createElement('div'); d.className = 'issue warn';
              d.innerHTML = `<div><strong>WARN:</strong> ${i.message}</div><div class="small">Suggestion: ${i.suggestion || '-'}</div>`;
              if (i.rows && i.rows.length && i.column) {
                d.style.cursor = 'pointer';
                d.onclick = () => selectCell(i.column, i.rows[0]);
              }
              issuesDiv.appendChild(d);
            });
          }
          resultsEl.appendChild(issuesDiv);
        } else {
          const okDiv = document.createElement('div');
          okDiv.innerHTML = '<h4>✅ No critical issues found</h4><div class="small">Data looks good — you can copy JSON or preview push.</div>';
          resultsEl.appendChild(okDiv);
        }

        // 2) Mapping UI: show current mapping and allow changing per field using dropdown (sheetHeaders)
        const mappingBox = document.createElement('div');
        mappingBox.className = 'mapping-box';
        mappingBox.innerHTML = '<h4>Header → Field mapping</h4><div class="small">Confirm or edit the header selected for each field. Save mapping to persist per-user (used next analyses).</div>';
        // Build table: for each canonical field show dropdown of sheet headers + option '— (none)'
        const mappingTable = document.createElement('div');
        const currentHeaderToField = resp.mapping || {}; // header->field
        // invert to field->header for convenience
        const fieldToHeader = {};
        for (const h in currentHeaderToField) {
          const f = currentHeaderToField[h];
          fieldToHeader[f] = h;
        }
        // Use LOAD_FIELDS order
        const fields = ["loadId","fromAddress","fromAppointmentDateTimeUTC","toAddress","toAppointmentDateTimeUTC","status","driverName","driverPhone","unitNumber","broker"];
        fields.forEach(f => {
          const row = document.createElement('div');
          row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems='center'; row.style.marginBottom='6px';
          const label = document.createElement('div'); label.style.width='220px'; label.innerHTML = `<strong>${f}</strong>`;
          const select = document.createElement('select');
          const noneOpt = document.createElement('option'); noneOpt.value = ''; noneOpt.text = '-- none --';
          select.appendChild(noneOpt);
          sheetHeaders.forEach(h => {
            const opt = document.createElement('option'); opt.value = h; opt.text = h;
            select.appendChild(opt);
          });
          // pre-select existing header if any
          if (fieldToHeader[f]) {
            select.value = fieldToHeader[f];
          } else {
            select.value = '';
          }
          row.appendChild(label);
          row.appendChild(select);
          mappingTable.appendChild(row);
        });

        mappingBox.appendChild(mappingTable);

        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn';
        saveBtn.textContent = 'Save mapping & re-run analysis';
        saveBtn.onclick = () => {
          // gather header->field mapping from selects
          const selects = mappingTable.querySelectorAll('select');
          const headerToField = {};
          const selFields = fields;
          selects.forEach((sel, idx) => {
            const header = sel.value;
            const field = selFields[idx];
            if (header) headerToField[header] = field;
          });
          // call server to save mapping and re-run analysis
          setStatus('Saving mapping and re-running analysis...');
          google.script.run.withSuccessHandler(function(newResp){
            // newResp is AnalysisResult
            handleAnalysisResponse(newResp);
          }).withFailureHandler(function(err){
            setStatus('Error saving mapping: ' + (err.message || err));
          }).saveUserMapping(headerToField);
        };
        mappingBox.appendChild(saveBtn);
        resultsEl.appendChild(mappingBox);

        // 3) If ok: show Loads JSON preview + Copy + Preview Push
        if (resp.ok && resp.loads && resp.loads.length) {
          const loadsBox = document.createElement('div');
          loadsBox.style.marginTop = '12px';
          loadsBox.innerHTML = `<h4>Loads JSON (preview)</h4>`;

          const pre = document.createElement('pre');
          pre.id = 'loadsJsonPreview';
          pre.textContent = JSON.stringify(resp.loads, null, 2);
          loadsBox.appendChild(pre);

          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn secondary';
          copyBtn.textContent = 'Copy JSON';
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(pre.textContent).then(()=> showModal('JSON copied to clipboard.'));
          };

          const pushBtn = document.createElement('button');
          pushBtn.className = 'btn';
          pushBtn.textContent = 'Preview Push (write preview sheet)';
          pushBtn.onclick = () => {
            setStatus('Pushing preview to a new sheet...');
            // call server previewPushToSheet
            google.script.run.withSuccessHandler(function(res){
              if (res && res.ok) {
                setStatus('Preview sheet created: ' + res.sheetName);
                showModal('Preview sheet created: ' + res.sheetName);
              } else {
                setStatus('Preview push failed: ' + (res && res.message));
                showModal('Preview push failed: ' + (res && res.message));
              }
            }).withFailureHandler(function(err){
              setStatus('Preview push failed: ' + (err.message || err));
              showModal('Preview push failed: ' + (err.message || err));
            }).previewPushToSheet(resp.loads);
          };

          const btnRow = document.createElement('div'); btnRow.className = 'action-row';
          btnRow.appendChild(copyBtn); btnRow.appendChild(pushBtn);
          loadsBox.appendChild(btnRow);

          resultsEl.appendChild(loadsBox);
        }

        // enable reanalyze
        reanalyzeBtn.disabled = false;
      }

      // helper: get sheet headers (simple RPC)
      function getSheetHeaders(callback) {
        google.script.run.withSuccessHandler(callback).withFailureHandler(function(err){
          console.error(err);
          callback([]);
        }).getSheetHeaders();
      }

      // Modal helper
      function showModal(msg) {
        alert(msg);
      }

      // RPC wrapper to select a cell
      function selectCell(colName, rowNum) {
        google.script.run.withSuccessHandler(function(){ /* focus */ }).withFailureHandler(function(err){
          console.error(err);
          showModal('Cannot navigate to cell: ' + (err.message || err));
        }).selectSheetCell(colName, rowNum);
      }

      // Expose for server callback
      window.handleAnalysisResponse = handleAnalysisResponse;

      // Small helper to call analyze once the page loads if desired
      document.addEventListener('DOMContentLoaded', function(){
        // Style tweaks already applied via CSS
      });
    </script>
  </body>
</html>
